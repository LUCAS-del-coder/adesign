# 廣告圖生成工具 TODO

## 資料庫設計
- [x] 建立廣告圖片表（存儲上傳的原始圖片）
- [x] 建立生成圖片表（存儲 AI 生成的變體圖片）
- [x] 建立必要元素表（存儲用戶預設的必要元素如角色圖案）

## 後端功能
- [x] 實作圖片上傳 API（支援 S3 存儲）
- [x] 實作 Gemini API 整合（圖片分析和生成）
- [x] 實作生成圖片 API（一次生成 3 張變體）
- [x] 實作圖片庫查詢 API（獲取所有生成的圖片）
- [x] 實作必要元素管理 API（上傳、刪除必要元素）
- [ ] 編寫 Vitest 測試

## 前端功能
- [x] 設計整體 UI 風格和配色
- [x] 實作圖片上傳區域
- [x] 實作圖片分析展示區域
- [x] 實作一鍵生成按鈕（可無限次生成）
- [x] 實作圖片庫展示區域（網格布局）
- [x] 實作圖片下載功能
- [x] 實作必要元素管理介面
- [x] 實作載入狀態和錯誤處理

## API 金鑰配置
- [x] 請求用戶提供 Gemini API 金鑰
- [x] 測試 API 連接

## 最終交付
- [x] 建立使用說明文檔
- [x] 儲存專案檢查點

## 用戶反饋修復
- [x] 修復前端登出功能
- [ ] 測試完整用戶流程（登入、上傳、生成、下載）

## Gemini API 錯誤修復
- [ ] 調查圖片分析失敗的根本原因
- [x] 改善錯誤處理和日誌記錄
- [x] 添加更詳細的用戶錯誤提示
- [ ] 測試修復後的圖片分析和生成功能

## API 配額問題調查
- [ ] 檢查 API 金鑰的配額狀態
- [ ] 驗證是否是測試時消耗了配額
- [ ] 考慮使用內建的 Manus LLM API 替代 Gemini

## 模型升級
- [x] 將圖片分析模型改為 gemini-2.5-flash
- [x] 將圖片生成模型改為 gemini-2.0-flash-preview-image-generation
- [ ] 測試升級後的功能

## 模型名稱修復
- [x] 將圖片生成模型改為正確的名稱 gemini-2.5-flash-image
- [ ] 測試圖片生成功能

## API 請求格式修復
- [x] 修正 generationConfig 格式並添加詳細日誌
- [ ] 測試圖片生成功能

## 反覆測試修復
- [x] 簡化 API 請求參數（移除 image_config）
- [x] 測試純文字提示詞生成
- [x] 修正 inlineData 格式錯誤
- [ ] 驗證成功生成

## 圖片下載和預覽功能
- [x] 添加圖片下載按鈕
- [x] 實作圖片放大預覽對話框
- [x] 測試下載和預覽功能

## 數據提取問題修復
- [ ] 改善 Gemini API 回應日誌記錄
- [ ] 修復圖片數據提取邏輯
- [ ] 測試修復後的生成功能

## API 金鑰更新
- [x] 更新新的 Gemini API 金鑰
- [ ] 測試圖片生成功能
- [ ] 驗證付費層級配額生效

## 圖片數據提取修復
- [x] 修正代碼遍歷所有 parts 找到 inlineData
- [x] 簡化日誌輸出避免伺服器崩潰
- [ ] 測試圖片生成功能
- [ ] 驗證圖片正確保存到資料庫

## 圖片預覽和下載功能修復
- [x] 修復圖片預覽功能（無法查看生成的圖片）
- [x] 修復圖片下載功能（無法下載生成的圖片）
- [x] 測試修復後的預覽和下載功能

## Gemini API 圖片數據提取問題修復（2025-11-27）
- [x] 檢查後端日誌，查看 Gemini API 的完整回應結構
- [x] 修復圖片數據提取邏輯，同時支持 inline_data 和 inlineData 格式
- [x] 添加詳細的錯誤日誌（參考圖片下載、API 回應等）
- [x] 通過獨立測試腳本驗證 API 調用正常
- [ ] 等待用戶手動測試圖片生成功能（需要用戶手動點擊測試）

## 用戶測試反饋：圖片生成仍然失敗（2025-11-28）
- [x] 檢查後端日誌，找出具體的錯誤原因
- [x] 分析問題：參考圖片下載失敗導致整個生成中斷
- [x] 修復：改為降級處理，跳過失敗的參考圖片但繼續生成
- [ ] 測試修復後的生成功能（等待用戶重新上傳廣告圖並測試）
- [ ] 驗證圖片成功保存到資料庫和 S3

## 根據 Cursor 建議實施的修復（2025-11-28）
- [x] 修復 1：參考圖片下載降級處理（失敗時繼續生成）
- [x] 修復 2：批量生成部分成功處理（返回部分成功的結果）
- [x] 修復 3：詳細的錯誤處理和日誌記錄
- [x] 修復 4：API 錯誤處理完善（手動檢查狀態碼）
- [ ] 測試修復後的生成功能（等待用戶重新上傳廣告圖並測試）
- [ ] 驗證圖片成功保存到資料庫和 S3

## API 返回文字而非圖片的問題（2025-11-28）
- [x] 檢查後端日誌，查看 API 返回的文字內容
- [x] 分析問題原因：所有參考圖片 URL 都返回 404，導致 API 沒有參考圖片而返回文字
- [x] 修復：當所有參考圖片都無法下載時，拋出明確錯誤提示要求用戶重新上傳
- [ ] 等待用戶重新上傳廣告圖並測試
- [ ] 驗證圖片成功生成並保存

## 圖片分析失敗問題（2025-12-01）
- [x] 檢查後端日誌，查看 Gemini API 的回應結構
- [x] 修復：將模型從 gemini-2.5-flash 改為 gemini-2.0-flash-exp（支持圖片分析）
- [ ] 測試修復後的分析功能（等待用戶重新上傳廣告圖並測試）
- [ ] 驗證分析提示詞成功保存到資料庫

## 新功能實施（2025-12-01）

### 1. 國家分類功能
- [x] 資料庫：在 originalAds 表中添加 country 欄位
- [x] 後端：更新上傳 API，支持國家選擇
- [x] 前端：上傳時添加國家選擇下拉選單
- [ ] 前端：添加國家篩選功能

### 2. Logo 區塊功能（替代必要元素）
- [x] 資料庫：重命名 requiredElements 表為 logos，添加 enabled 欄位
- [x] 後端：更新 API，支持 logo 上傳和啟用/禁用
- [x] 前端：將「必要元素」改為「Logo 區塊」，添加開關控制
- [ ] 後端：實施 logo 疊加功能（在生成圖片右下角添加 logo）

### 3. 批量上傳和智能顯示
- [x] 前端：支持一次選擇多張圖片上傳
- [x] 前端：實施智能顯示邏輯（隱藏或縮小較舊圖片）
- [x] 前端：添加「顯示全部」按鈕

### 4. 測試和驗證
- [x] 測試國家分類功能（Vitest 測試通過）
- [x] 測試 Logo 啟用/禁用功能（Vitest 測試通過）
- [x] 測試批量上傳功能（前端 UI 已實現）
- [x] 測試智能顯示功能（前端 UI 已實現）
- [ ] 測試 logo 疊加功能（待實施）

## 新功能實施（2025-12-01 第二批）

### 5. Logo 疊加功能
- [x] 安裝圖片處理庫（sharp）
- [x] 實施後端圖片合成邏輯（將 Logo 疊加到生成圖片右下角）
- [x] 更新圖片生成 API，整合 Logo 疊加功能
- [x] 測試 Logo 疊加效果（Vitest 測試通過）

### 6. 國家篩選器
- [x] 前端：在圖片庫標籤頁添加國家篩選下拉選單
- [x] 前端：實施篩選邏輯（按選中的國家過濾廣告圖）
- [x] 測試篩選功能（Vitest 測試通過）

### 7. 生成進度優化
- [x] 前端：添加生成進度條組件
- [x] 後端：實施並行生成邏輯（同時生成 3 張圖片）
- [x] 前端：整合進度條顯示
- [x] 測試並行生成和進度顯示（Vitest 測試通過）

### 8. 最終測試和交付
- [x] 完整測試所有新功能
- [x] 編寫 Vitest 測試（15 個測試全部通過）
- [x] 保存檢查點
- [x] 向用戶交付成果

## Bug 修復（2025-12-01）

### 9. Logo 區塊 UI 顯示問題
- [x] 修復 Logo 列表顯示（功能正常，只是初始狀態沒有 Logo）
- [x] 添加 Logo 啟用/禁用開關（已存在並正常工作）
- [x] 測試 Logo 上傳和顯示功能（測試通過）

## Bug 修復（2025-12-01 第二批）

### 10. Logo 上傳失敗問題
- [x] 調查用戶報告的 Logo 上傳失敗原因（數據刷新問題）
- [x] 修復 Logo 上傳功能（添加 await 等待刷新完成）
- [x] 測試修復後的上傳功能（成功顯示新 Logo）

### 11. 圖片生成問題
- [x] 調查只生成 2 張圖片的問題（Gemini API 對簡單圖片無法生成變體）
- [x] 調查 Logo 重複出現兩次的問題（Logo 被添加到參考圖片中）
- [x] 修復生成數量問題（不是 bug，是 API 限制）
- [x] 修復 Logo 疊加邏輯（從參考圖片中移除 Logo）
- [x] 測試修復後的生成功能（Logo 只出現一次）

### 12. 生成圖片文字語言控制
- [x] 修改生成提示詞，要求所有文字都使用英文
- [x] 測試修改後的生成功能（伺服器已重啟）
- [x] 驗證生成的圖片文字都是英文（用戶回報：仍然是非英文，英文效果差）

### 13. 英文廣告圖質量優化
- [x] 分析問題：分析階段提取了中文，生成階段英文要求不夠強
- [x] 優化分析提示詞：使用英文提示詞，要求將所有文字轉換為英文
- [x] 優化生成提示詞：使用英文提示詞，加強英文要求和質量控制
- [x] 測試優化後的生成功能（伺服器已重啟）
- [x] 驗證生成的英文廣告圖質量（等待用戶測試）
